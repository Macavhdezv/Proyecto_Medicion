---
title: "script oficial"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Insertar librerías que vamos a usar

```{r}
library(tidyverse)
library(readxl)
library(janitor)
library(dplyr)
library(stringi)
library(dplyr)
library(ggplot2)
library(chilemapas)
library(janitor)
library(gganimate)
library(plotly)
library(stargazer)
```

# Usamos la base de datos final para todo:

```{r}
df_final <- read_csv("data/base_final_lista23nov.csv")
```

# Unimos bases para tener códigos y generamos la variable de porcentajes

```{r}
cut_data <- read_xls("input/CUT_2018_v04.xls") |> 
  clean_names() |> 
  select(codigo_comuna_2018, nombre_comuna) |> 
  rename(comuna = nombre_comuna) |> 
  mutate(comuna = stri_trans_general(comuna, "Latin-ASCII")) |> 
  mutate(
    comuna = case_when(
      comuna == "Paiguano" ~ "Paihuano",
      comuna == "Llay-Llay" ~ "Llay Llay",
      comuna == "Marchigue" ~ "Marchihue",
      comuna == "Cabo de Hornos" ~ "Cabo de Hornos(Ex-Navarino)",
      comuna == "San Pedro de La paz" ~ "San Pedro de la paz",
      comuna == "San Juan de La Costa" ~ "San Juan de la Costa",
      comuna == "O'higgins" ~ "O'Higgins",
      comuna == "Treguaco" ~ "Trehuaco",
      TRUE ~ comuna
    )
  )
  
df_final <- df_final |> 
  left_join(cut_data, by = "comuna")

#Agregamos ciertas variables para futuras gráficas

df_final <- df_final |> 
  rowwise() |> 
  mutate(porc_apruebo_2022 = apruebo/(apruebo+rechazo),
         porc_afavor_2023 = a_favor/(a_favor+en_contra))

df_final <- df_final |> 
  rowwise() |> 
  mutate(ed_superior_porc = superior / poblacion_censada.y)

df_final <- df_final |> 
  mutate(
    tendencia = case_when(
      pacto %in% c("Chile Vamos", "Unidos Por La Dignidad") ~ "Derecha",
      pacto %in% c("Unidad Por El Apruebo", "Frente Amplio", "Chile Digno Verde Y Soberano", "Dignidad Ahora") ~ "Izquierda",
      pacto == "Independientes" ~ "Independiente",
      TRUE ~ "Otro"
    )
  )



summary(df_final)

summary(df_final$porc_apruebo_2022)
summary(df_final$porc_afavor_2023)
```

#Gráficos

# Gráfico promedio de años de escolaridad para el APRUEBO:

#1.Mujeres

```{r}

#Gráfico 1

  ggplot(
    df_final, 
    aes(
      x = escolaridad_promedio_mujeres_18_mas,
      y = porc_apruebo_2022
    )
  ) +
  geom_point(color = "#8B1C62", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
  geom_text(
    data = df_final %>% 
      filter(
        porc_apruebo_2022 < 0.25  &
          escolaridad_promedio_mujeres_18_mas > 14
      ),
    aes(label = comuna),
    size = 2.5,
    color = "black",
    check_overlap = TRUE,
    nudge_y = 0.01
  ) +
    scale_y_continuous(limits = c(0, 0.9)) +
  labs(
    title = "Escolaridad promedio de mujeres (18+) y apoyo al Apruebo 2022",
    subtitle = "Relación entre la escolaridad promedio de mujeres adultas y el apoyo al Apruebo
en el Plebiscito Constitucional 2022",
    x = "Años de escolaridad promedio mujeres 18+",
    y = "Porcentaje Apruebo 2022",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 13, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

#2.Hombres

```{r}
#Gráfico 2
  ggplot(
    df_final, 
    aes(
      x = escolaridad_promedio_hombres_18_mas,
      y = porc_apruebo_2022
    )
  ) +
    geom_point(color = "turquoise4", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
    geom_text(
      data = df_final %>% 
        filter(
          porc_apruebo_2022 < 0.25 &
            escolaridad_promedio_mujeres_18_mas > 14.0
        ),
      aes(label = comuna),
      size = 2.5,
      color = "black",
      check_overlap = TRUE,
      nudge_y = 0.01
    ) +
    scale_y_continuous(limits = c(0, 0.9)) +
    labs( 
      title = "Escolaridad promedio de hombres (18+) y apoyo al apruebo 2022",
      subtitle = "Relación entre la escolaridad promedio de hombres adultos y el apoyo al Apruebo
en el plebiscito del 2022",
      x = "Años de escolaridad promedio hombres 18+",
      y = "Porcentaje Apruebo 2022",
      caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 13, face = "bold"),
      axis.title = element_text(size = 11)
    )  
```

#2 Años de escolaridad y porcentaje de votos a favor

#1.Mujer

```{r}
#grráfico 3
ggplot(
    df_final, 
    aes(
      x = escolaridad_promedio_mujeres_18_mas,
      y = porc_afavor_2023
    )
  ) +
  geom_point(color = "#8B1C62", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
  geom_text(
    data = df_final %>% 
      filter(
        porc_afavor_2023 > 0.60 &
          escolaridad_promedio_mujeres_18_mas > 14
      ),
    aes(label = comuna),
    size = 2.5,
    color = "black",
    check_overlap = TRUE,
    nudge_y = 0.01
  ) +
    scale_y_continuous(limits = c(0, 0.9)) +
  labs(
    title = "Escolaridad promedio de mujeres (18+) y apoyo al A favor 2023",
    subtitle = "Relación entre la escolaridad promedio de mujeres adultas y el apoyo al A favor
en el plebiscito del 2023",
    x = "Años de escolaridad promedio mujeres 18+",
    y = "Porcentaje A favor 2023",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 13, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

#2.Hombres

```{r}

#Gráfico 4

  ggplot(
    df_final, 
    aes(
      x = escolaridad_promedio_hombres_18_mas,
      y = porc_afavor_2023
    )
  ) +
    geom_point(color = "turquoise4", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
    geom_text(
      data = df_final%>% 
        filter(
          porc_afavor_2023 > 0.6 &
            escolaridad_promedio_hombres_18_mas > 15
        ),
      aes(label = comuna),
      size = 2.5,
      color = "black",
      check_overlap = TRUE,
      nudge_y = 0.01
    ) +
    scale_y_continuous(limits = c(0, 0.9)) +
    labs(
      title = "Escolaridad promedio de hombres (18+) y apoyo al A favor 2023",
      subtitle = "Relación entre la escolaridad promedio de hombres adultos y el apoyo al A favor
en el plebiscito del 2023",
      x = "Años de escolaridad promedio hombres 18+",
      y = "Porcentaje A favor 2023",
      caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 13, face = "bold"),
      axis.title = element_text(size = 11)
    )  
```


```{r}

#Gráfico 4 

cor.test(df_final$escolaridad_promedio_mujeres_18_mas, df_final$porc_afavor_2023, use = "complete.obs", method = "pearson") 

#esto entrega un valor p, el cual es menor a 0.5
```

#3 porcentaje de pobreza y porcentaje de votos

#APRUEBO 2022

```{r}

#gráfico 5

  ggplot(
    df_final, 
    aes(
      x = porcentaje_de_personas_en_situacion_de_pobreza_por_ingresos_2022,
      y = porc_apruebo_2022
    )
  ) +
    
    # Puntos
    geom_point(color = "#FF8C00", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
    geom_text(
      data = df_final %>%
        filter(
            porc_apruebo_2022 < 0.25 &
            porcentaje_de_personas_en_situacion_de_pobreza_por_ingresos_2022 < 0.02
        ),
      aes(label = comuna),
      size = 2.5,
      color = "black",
      check_overlap = TRUE,
      nudge_y = 0.01
    ) +
    scale_y_continuous(limits = c(0, 0.9)) +
    labs(
      title = "Porcentaje de pobreza comunal y apoyo al Apruebo 2022",
      subtitle = "Relación entre el porcentaje de pobreza comunal y el apoyo al Apruebo 
en el Plebiscito Constitucional 2022",
      x = "Porcentaje de pobreza",
      y = "Porcentaje Apruebo 2022",
      caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nEncuesta CASEN 2022.\nElaboración propia."
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 13, face = "bold"),
      axis.title = element_text(size = 11)
    )
```

# AFAVOR 2023

```{r}
#gráfico 6
  ggplot(
    df_final, 
    aes(
      x = porcentaje_de_personas_en_situacion_de_pobreza_por_ingresos_2022,
      y = porc_afavor_2023
    )
  ) +
    
    # Puntos
    geom_point(color = "#CD5B45", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
    geom_text(
      data = df_final %>%
        filter(
            porc_afavor_2023 > 0.6 &
            porcentaje_de_personas_en_situacion_de_pobreza_por_ingresos_2022 < 0.02
        ),
      aes(label = comuna),
      size = 2.5,
      color = "black",
      check_overlap = TRUE,
      nudge_y = 0.01
    ) +
    scale_y_continuous(limits = c(0, 0.9)) + 
    labs(
      title = "Porcentaje de pobreza comunal y apoyo al A favor 2023",
      subtitle = "Relación entre el porcentaje de pobreza comunal y el apoyo al A favor
en el Plebiscito Constitucional 2023",
      x = "Porcentaje de pobreza",
      y = "Porcentaje A favor 2023",
      caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nEncuesta CASEN 2022.\nElaboración propia."
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 13, face = "bold"),
      axis.title = element_text(size = 11)
    )
```

#3. porcentaje de mujeres u hombres en la población: AFAVOR

#Mujeres

```{r}

#Gráfico 7

ggplot(
    df_final, 
    aes(
      x = porcentaje_mujeres,
      y = porc_afavor_2023
    )
  ) +
  geom_point(color = "#8B1C62", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
  geom_text(
    data = df_final %>% 
      filter(
        porc_afavor_2023 > 0.79 &
          porcentaje_mujeres > 45 
      ),
    aes(label = comuna),
    size = 2.5,
    color = "black",
    check_overlap = TRUE,
    nudge_y = 0.01
  ) +
    scale_y_continuous(limits = c(0, 0.9)) +
  labs(
    title = "porcentaje de mujeres comunal y apoyo al A favor 2023",
    subtitle = "Relación entre el porcentaje de mujeres en la población comunal y el apoyo al A favor
en el plebiscito del 2023",
    x = "porcentaje de mujeres que viven en la comuna",
    y = "Porcentaje A favor 2023",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 13, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

No se ve tanto sentido con lo que se vota a favor,

```{r}
#Correlación

cor.test(df_final$porcentaje_mujeres, df_final$porc_afavor_2023, use = "complete.obs", method = "pearson")

```

![](images/clipboard-3147672180.png)


#2.Hombres

```{r}

#gráfico 8

  ggplot(
    df_final, 
    aes(
      x = porcentaje_hombres,
      y = porc_afavor_2023
    )
  ) +
    geom_point(color = "turquoise4", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
    geom_text(
      data = df_final%>% 
        filter(
          porc_afavor_2023 > 0.75 &
            porcentaje_hombres < 55
        ),
      aes(label = comuna),
      size = 2.5,
      color = "black",
      check_overlap = TRUE,
      nudge_y = 0.01
    ) +
    scale_y_continuous(limits = c(0, 0.9)) +
    labs(
      title = "porcentaje de hombres comunal y apoyo al A favor 2023",
      subtitle = "Relación entre el porcentaje de hombres en la población comunal y el apoyo
al A favor en el plebiscito del 2023",
      x = "porcentaje de hombres que viven en la comuna",
      y = "Porcentaje A favor 2023",
      caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 13, face = "bold"),
      axis.title = element_text(size = 11)
    )  
```

#4.porcentaje de mujeres u hombres en la población: APRUEBO

#Mujeres

```{r}
#Gráfico 9

ggplot(
    df_final, 
    aes(
      x = porcentaje_mujeres,
      y = porc_apruebo_2022
    )
  ) +
  geom_point(color = "#8B1C62", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
  geom_text(
    data = df_final %>% 
      filter(
        porc_apruebo_2022 < 0.10 &
          porcentaje_mujeres > 45
      ),
    aes(label = comuna),
    size = 2.5,
    color = "black",
    check_overlap = TRUE,
    nudge_y = 0.01
  ) +
    scale_y_continuous(limits = c(0, 0.9)) +
  labs(
    title = "Porcentaje de mujeres comunal y apoyo al Apruebo 2022",
    subtitle = "Relación entre el porcentaje de mujeres en la población comunal y el apoyo 
al Apruebo en el plebiscito del 2022",
    x = "porcentaje de mujeres que viven en la comuna",
    y = "Porcentaje Apruebo 2022",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 13, face = "bold"),
    axis.title = element_text(size = 11)
  )

```

#2.Hombres

```{r}
#Gráfico 10
  ggplot(
    df_final, 
    aes(
      x = porcentaje_hombres,
      y = porc_apruebo_2022
    )
  ) +
    geom_point(color = "turquoise4", size = 2, alpha = 0.7) +
    geom_smooth(method = "lm") +
    geom_text(
      data = df_final%>% 
        filter(
          porc_apruebo_2022 < 0.10 &
            porcentaje_hombres < 60
        ),
      aes(label = comuna),
      size = 2.5,
      color = "black",
      check_overlap = TRUE,
      nudge_y = 0.01
    ) +
    scale_y_continuous(limits = c(0, 0.9)) +
    labs(
      title = "Porcentaje de hombres comunal y apoyo al Apruebo 2022",
      subtitle = "Relación entre el porcentaje de hombres en la población comunal y el apoyo al
Apruebo en el plebiscito del 2022",
      x = "Porcentaje de hombres que viven en la comuna",
      y = "Porcentaje Apruebo 2022",
      caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 13, face = "bold"),
      axis.title = element_text(size = 11)
    )  
```


#5.gráfico "Distribución del apoyo al apruebo 2022 agrupando número de municipios según tendencia política al que pertenece el alcalde por comunas"

```{r}


#APRUEBO 2022 -> gráfico 11

summary(df_final$porc_apruebo_2022)
# Crear la variable categórica (muy bajo, bejo, medio y alto) basada en los cuartiles

df_final$porc_apruebo_categorias <- cut(
  df_final$porc_apruebo_2022,
  breaks = c(-Inf, 0.24767, 0.32358, 0.39203, Inf),
  labels = c("Muy Bajo", "Bajo", "Medio", "Alto"),
  include.lowest = TRUE,
  right = TRUE
)

df_grafico11 <- df_final |> 
  group_by(tendencia, porc_apruebo_categorias) |> 
  summarise(conteo_comuna = n(), .groups = "drop")

#Aprovechamos hacerlo también con la variable para A favor

summary(df_final$porc_afavor_2023)

df_final$porc_afavor_categorias <- cut(
  df_final$porc_afavor_2023,
  breaks = c(-Inf, 0.4090, 0.4700, 0.5362, Inf),
  labels = c("Muy Bajo", "Bajo", "Medio", "Alto"),
  include.lowest = TRUE,
  right = TRUE
)
df_grafico12 <- df_final |> 
  group_by(tendencia, porc_afavor_categorias) |> 
  summarise(conteo_comuna = n(), .groups = "drop")

#Grafico para el apruebo

df_grafico5 %>%
  ggplot(aes(x = porc_apruebo_categorias, y = conteo_comuna)) +
  geom_col(fill = "#f4a6c6", color = "gray20") +
  geom_text(
    aes(label = conteo_comuna),
    vjust = -0.3,
    size = 4,
    fontface = "bold",
    color = "black"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.5))) +
  labs(
    title = "Distribución del apoyo al Apruebo 2022",
    subtitle = "Número de municipios según la tendencia política del alcalde",
    x = "Porcentaje de Apruebo (Clasificado por Cuartiles)",
    y = "Cantidad de Municipios",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  facet_grid(rows = vars(tendencia)) +
  theme_minimal(base_size = 12)

#gráfico para el A favor --> gráfico 12

df_grafico12 %>%
  ggplot(aes(x = porc_afavor_categorias, y = conteo_comuna)) +
  geom_col(fill = "#f4a6c6", color = "gray20") +
  geom_text(
    aes(label = conteo_comuna),
    vjust = -0.3,
    size = 4,
    fontface = "bold",
    color = "black"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.5))) +
  labs(
    title = "Distribución del apoyo al A favor 2023",
    subtitle = "Número de municipios según la tendencia política del alcalde",
    x = "Porcentaje de Apruebo (Clasificado por Cuartiles)",
    y = "Cantidad de Municipios",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  facet_grid(rows = vars(tendencia)) +
  theme_minimal(base_size = 12)

```


# 6. Gráficos Porcentaje apruebo y porcentaje de población con educación superior

#apruebo: gráfico 13

```{r}
ggplot(
  df_final, 
  aes(
    x = ed_superior_porc,
    y = porc_apruebo_2022
  )
) +
  geom_point(color = "#457b9d", size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", 
              color = "#e63946") +
  geom_text(
    data = df_final %>% 
      filter(
        porc_apruebo_2022 < 0.24  &
          ed_superior_porc > 0.5
      ),
    aes(label = comuna),
    size = 2.5,
    color = "black",
    check_overlap = TRUE,
    nudge_y = 0.01
  ) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
  scale_x_continuous(labels = scales::percent) +
  labs(
    title = "Votación del Apruebo y educación superior por comuna",
    subtitle = "Relación entre apoyo al Apruebo y nivel educativo de la población comunal\n(Plebiscito Constitucional 2022)",
    x = "Porcentaje de población con educación superior (comunas)",
    y = "Porcentaje de votos para el Apruebo (votos válidos)",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  theme_minimal(base_family = "Roboto") +
  theme(
    plot.title = element_text(size = 13, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

#Rechazo: gráfico 14

```{r}
ggplot(
  df_final, 
  aes(
    x = ed_superior_porc,
    y = porc_afavor_2023
  )
) +
  geom_point(color = "#00008B", size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", 
              color = "#e63946") +
  geom_text(
    data = df_final %>% 
      filter(
        porc_afavor_2023 > 0.5  &
          ed_superior_porc > 0.6
      ),
    aes(label = comuna),
    size = 2.5,
    color = "black",
    check_overlap = TRUE,
    nudge_y = 0.01
  ) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
  scale_x_continuous(labels = scales::percent) +
  labs(
    title = "Votación del A favor y educación superior por comuna",
    subtitle = "Relación entre apoyo al A favor y nivel educativo de la población comunal\n(Plebiscito Constitucional 2023)",
    x = "Porcentaje de población con educación superior (comunas)",
    y = "Porcentaje de votos para el A favor (votos válidos)",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  theme_minimal(base_family = "Roboto") +
  theme(
    plot.title = element_text(size = 13, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

#7 gráfico de mapa RM: 

```{r}
mapa_chile <- read_sf("data/geometrias/comunas.shp")

colnames(mapa_chile)

# Estandarizo la variable comuna

mapa_chile_limpia <- mapa_chile |> 
  mutate(Comuna = str_to_lower(Comuna),
         Comuna = stringi::stri_trans_general(Comuna, "latin-ascii")) |> 
  filter(codregion == 13)

df_final_limpia <- df_final |> 
  mutate(comuna = str_to_lower(comuna),
         comuna = stringi::stri_trans_general(comuna, "latin-ascii"))

# Veo que no haya problemas con las comunas de la RM
  
mapa_chile_limpia |> 
  anti_join(df_final_limpia, by = c("Comuna"="comuna")) |> 
  select(Comuna)

# Uno las bases de datos

mapa_chile_modelos <- mapa_chile_limpia |> 
  left_join(df_final_limpia, by = c("Comuna"="comuna"))

mapa_chile_modelos <- mapa_chile_modelos |> 
  filter(!is.na(Region))

str(mapa_chile_modelos)

# Gráfico de mapa de educación superior: 15

mapa_chile_modelos |> 
  ggplot() +
  geom_sf(aes(fill = ed_superior_porc)) +
  scale_fill_gradient(name = "% educación superior:",
                      low = "#fcb9b2", high = "#461220") +
  labs(
    title = "Educación superior",
    subtitle = "Porcentaje de personas con educación superior por comuna (Censo 2024).\nRegión Metropolitana.",
    caption = "Fuente: Instituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  theme_linedraw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank())

#Gráfico 16: Porcentaje de apruebo

mapa_chile_modelos |> 
  ggplot() +
  geom_sf(aes(fill = porc_apruebo_2022)) +
  scale_fill_gradient(name = "% Apruebo:",
                      low = "lavenderblush", high = "#8B3A62") +
  labs(
    title = "Distribución del apoyo al Apruebo",
    subtitle = "Porcentaje de votos emitidos para el apruebo en el plebiscito 2022 
por comuna (SERVEL, 2022).\nRegión Metropolitana.",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nElaboración propia."
  ) +
  theme_linedraw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank())

#Gráfico 17: Porcentaje de A favor

mapa_chile_modelos |> 
  ggplot() +
  geom_sf(aes(fill = porc_afavor_2023)) +
  scale_fill_gradient(name = "% A favor:",
                      low = "lavenderblush", high = "#8B3A62") +
  labs(
    title = "Distribución del apoyo al A favor",
    subtitle = "Porcentaje de votos emitidos para el A favor en el plebiscito 2023 
por comuna (SERVEL, 2023).\nRegión Metropolitana.",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nElaboración propia."
  ) +
  theme_linedraw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank())

```

#Gráfico

```{r}
df_final <- df_final |> 
  mutate(grupo_edad_unido = as.factor(grupo_edad_unido))

df_final$rango_etario <- factor(
  df_final$grupo_edad_unido,
  levels = 1:3,
  labels = c("20-34 años", "35-49 años", "50-64 años")
)
  
df_grafico18 <- df_final |> 
  group_by(rango_etario, porc_apruebo_categorias) |> 
  summarise(conteo_comuna = n(), .groups = "drop")

#Gráfico: 18 APRUEBO

df_grafico18 |> 
  ggplot(aes(x = porc_apruebo_categorias, y = conteo_comuna)) +
  geom_col(fill = "#f4a", color = "gray20") +
  geom_text(
    aes(label = conteo_comuna),
    vjust = -0.3,
    size = 4,
    fontface = "bold",
    color = "black"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.5))) +
  labs(
    title = "Distribución del apoyo al Apruebo 2022",
    subtitle = "Número de municipios por rango etario según su nivel de
preferencia al apruebo",
    x = "Porcentaje de Apruebo (Clasificado por Cuartiles)",
    y = "Cantidad de Municipios",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  facet_grid(rows = vars(rango_etario)) +
  theme_minimal(base_size = 12)

#Gráfico: 19 A favor

df_grafico19 <- df_final |> 
  group_by(rango_etario, porc_afavor_categorias) |> 
  summarise(conteo_comuna = n(), .groups = "drop")

df_grafico19 |> 
  ggplot(aes(x = porc_afavor_categorias, y = conteo_comuna)) +
  geom_col(fill = "#CD2990", color = "gray20") +
  geom_text(
    aes(label = conteo_comuna),
    vjust = -0.3,
    size = 4,
    fontface = "bold",
    color = "black"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.5))) +
  labs(
    title = "Distribución del apoyo al A favor 2023",
    subtitle = "Cantidad de municipios por rango etario según su nivel de
preferencia por el A favor",
    x = "Porcentaje de A favor (Clasificado por Cuartiles)",
    y = "Cantidad de Municipios",
    caption = "Fuente: Servicio Electoral de Chile (SERVEL), Resultados electorales históricos.\nInstituto Nacional de Estadísticas (INE), Resultados CENSO 2024.\nElaboración propia."
  ) +
  facet_grid(rows = vars(rango_etario)) +
  theme_minimal(base_size = 12)

```
# Transformaciones para Regresión Lineal Múltiple:

```{r}
df_final <- df_final |> 
  mutate(tendencia = as.factor(tendencia))
```

# Revisión de distribución
```{r}
df_final |> 
  ggplot(aes(x = porc_apruebo_2022)) +
  geom_histogram()

df_final |> 
  ggplot(aes(x = porc_afavor_2023)) +
  geom_histogram()
```

# Modelos de Regresión Lineal:

```{r}
mod_sim_2022 <- lm(porc_apruebo_2022 ~ ed_superior_porc + porcentaje_mujeres + escolaridad_promedio_mujeres_18_mas + porcentaje_de_personas_en_situacion_de_pobreza_por_ingresos_2022 +tendencia + grupo_edad_unido, data = df_final)

summary(mod_sim_2022)

mod_sim_2023 <- lm(porc_afavor_2023 ~ ed_superior_porc + porcentaje_mujeres + escolaridad_promedio_mujeres_18_mas + porcentaje_de_personas_en_situacion_de_pobreza_por_ingresos_2022 +tendencia + grupo_edad_unido, data = df_final)

summary(mod_sim_2023)

stargazer(mod_sim_2022, mod_sim_2023,
          type = "text",
          title = "Análisis Lineal de Votos en 2022 y 2023",
          column.labels = c("Plebiscito 2022", "Plebiscito 2023"),
          covariate.labels = c("% Educación Superior", "% Mujeres","Escolaridad Promedio Mujeres", "Pobreza por Ingresos", "Tendencia: Independientes", "Tendencia: Izquierda", "Edad: 35-49", "Edad: 50-64", "Constante"),
          digits = 3,
          star.cutoffs = c(0.05, 0.01, 0.001),
          out = "output/tabla_1.html")
```

# Transformaciones para Regresión Logística

```{r}
df_final <- df_final |>
  mutate(pleb_2022_bin = ifelse(apruebo > rechazo, 1, 0 ) |> as.factor())

df_final <- df_final |> 
  mutate(pleb_2023_bin = ifelse(a_favor > en_contra, 1, 0) |> as.factor())
```

# Regresiones Logísticas

```{r}
modelo_2022 <- glm(pleb_2022_bin ~ ed_superior_porc + porcentaje_mujeres + escolaridad_promedio_mujeres_18_mas +  porcentaje_de_personas_en_situacion_de_pobreza_por_ingresos_2022 +tendencia + grupo_edad_unido,
                   data = df_final,
                   family = binomial(link = "logit"))

summary(modelo_2022)

modelo_2023 <- glm(pleb_2023_bin ~ ed_superior_porc + porcentaje_mujeres + escolaridad_promedio_mujeres_18_mas +  porcentaje_de_personas_en_situacion_de_pobreza_por_ingresos_2022 +tendencia + grupo_edad_unido,
                   data = df_final,
                   family = binomial(link = "logit"))

summary(modelo_2023)

stargazer(modelo_2022, modelo_2023,
          type = "text",
          title = "Análisis Logístico del Voto 2022 y 2023",
          column.labels = c("Plebiscito 2022", "Plebiscito 2023"),
          covariate.labels = c("% Educación Superior", "% Mujeres", "Escolaridad Promedio Mujeres", "Población Comunal", "Pobreza por Ingresos", "Tendencia: Independiente", "Tendencia: Izquierda", "Edad: 35-49", "Edad: 50-64", "Constante"),
          digits = 3,
          star.cutoffs = c(0.05, 0.01, 0.001),
          no.space = TRUE, 
          out = "output/tabla_2.html")
```

